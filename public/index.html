<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Anime List 3.0</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-vue.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css">
  </head>
  <body>
    <div id="app">
        <top-bar :allanime="allAnime" @anime="showAnime" @change_page="change_page"></top-bar>
        <div class="container mt-4">
            <transition name='slide' mode="out-in">
                <component 
                    :is="currentPage" 
                    :anime="selectedAnime" 
                    :watch="watch"
                    :all_anime="allAnime"
                    :watching="watching"
                    @watch="watchOnline" 
                    @change_page="change_page"
                    @anime="showAnime"
                    @update-all-anime="updateAllAnime">
                </component>
            </transition>
        </div>
    </div>
    
    <!-- Templates -->
    <template id='topBar-tmp'>
        <nav class="navbar sticky-top mb-2 navbar-expand-sm">
            <a class="navbar-brand" href="#" @click="start_page">Anime List 3.0 <span>v{{appVersion}}</span></a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="#" @click="change_page('about')"><i class="fa fa-info" aria-hidden="true"></i></a>
                    </li>
                </ul>
            </div>
            <form class="form-inline">
                <!-- @blur="search=''" @input="onlineSearch" -->
                <input class="form-control" type="text" placeholder="Поиск" aria-label="Search" v-model="search" @input="onlineSearch" @blur="clear">
            </form>
            <transition name='fade'>
                <ul id="searchResult" v-show="search.length">
                    <li class="header">Локальный поиск:</li>
                    <li class="item" v-for="item in searchLocal" @click="selectSearch(item)">{{ item.russian }}<br><span>{{ item.name }}</span></li>
                    <li v-if="searchLocal.length === 0">Ничего не найдено</li>
                    
                    <li class="header">Онлайн поиск:</li>
                    <li class="loader" v-if="onlineSearchLoading">Loading...</li>
                    <li class="item" v-for="item in searchOnline" v-else-if="searchOnline.length > 0" @click="selectOnline(item.id)">{{ item.russian }}<br><span>{{ item.name }}</span></li>
                    <li v-else>Ничего не найдено</li>
                </ul>
            </transition>
        </nav>
    </template>
    <template id="start-tmp">
        <div class="start">
            <h4>Смотрю</h4>
            <b-card-group deck class="watching mb-3 pb-2">
                <b-card overlay
                    v-for="anime in watching"
                    key="anime.id"
                    :img-src="'https://shikimori.org/' +anime.image.original"
                    :img-alt="anime.name"
                    :title="anime.russian"
                    :sub-title="anime.name"
                    @click="show_anime(anime)">
                    <p class='card-text'>{{anime.watched}} / {{anime.episodes_aired || anime.episodes}}</p>
                </b-card>
            </b-card-group>
            <h4>Избранное</h4>
            <b-card-group columns>
                    <b-card overlay
                        v-for="anime in all_anime"
                        key="anime.id"
                        :img-src="'https://shikimori.org/' +anime.image.original"
                        :img-alt="anime.name"
                        :title="anime.russian"
                        :sub-title="anime.name"
                        @click="show_anime(anime)">
                    </b-card>
            </b-card-group>
        </div>
    </template>
    <template id="anime-tmp">
        <div class="anime">
            <div class='info d-flex mb-4'>
                <div class='left-side mr-4'>
                    <img :src="'https://shikimori.org/' + anime.image.original" :alt="anime.name" class="thumb">
                </div>
                <div class="right-side d-flex flex-column justify-content-around">
                    <div class="studios">
                        <img v-for="studio in anime.studios" :src="'https://shikimori.org/' + studio.image" a:lt="studio.name" class='studio mb-1'>
                    </div>
                    <div>
                        <h5>{{ anime.russian }} <small class='text-muted'>{{ new Date(anime.aired_on).getFullYear() }}</small></h5>
                        <h6>{{ anime.name }}</h6>
                        <div>
                            <span class="genre" v-for='genre in anime.genres'>{{ genre.russian }}</span>
                        </div>
                    </div>
                    <div>
                        <span class="text-primary" v-if="anime.status=='released'">{{anime.episodes}} / {{anime.episodes}} эп.</span>
                        <span class="text-primary" v-else>{{anime.episodes_aired}} / {{anime.episodes > 0 ? anime.episodes : '??'}} эп.</span>
                         • <span class="text-primary">{{ anime.duration }} мин.</span>
                    </div>
                    <div v-if="nextEpDate">Следующая серия: {{nextEpDate}}</div>
                    <div><h3 class="text-primary">{{anime.score}}</h3></div>
                    <div v-if="anime.watched">Просмотрено: {{ anime.watched }}</div>
                    <div class='mt-3'>
                        <button class="btn btn-outline-warning" @click="watchButton"><i class="fa fa-play"></i> Смотреть</button>
                        <button class="btn" :class="favoriteClass" @click="favorite"><i class="fa fa-star"></i> В избранное</button>
                        <button class="btn" :class="alreadyWatchedClass" @click="alreadyWatched"><i class="fa fa-check"></i> Уже просмотрено</button>
                    </div>
                </div>
            </div>
            <div class="description" v-if="anime.description"><b>Описание:</b> <p v-html="cleanDescr"></p></div>
            <template v-if="hasMedia">
                <hr>
                <h5>Медиа</h5>
                <div class="screensVideo">
                    <media :preview="screen.preview" :full="screen.original" v-for="screen in anime.screenshots"></media>
                    <media :preview="video.image_url" :full="video.player_url" v-for="video in anime.videos" key="video.id"></media>
                </div>
            </template>
            <hr>
            <h5>Связанное</h5>
            <div class="related">
                <div v-for="relate in anime.related" class="d-flex" :class="{ anime: relate.anime, manga: relate.manga}">
                    <template v-if="relate.anime">
                        <div class="img-wrap" @click="select_anime(relate.anime.id)">
                            <img :src="'https://shikimori.org/'+relate.anime.image.x96" alt="">
                        </div>
                        <div>
                            <h6 @click="select_anime(relate.anime.id)">{{relate.anime.russian}}</h6>
                            <div>{{ relatedKind(relate.anime.kind) }} {{ new Date(relate.anime.aired_on).getFullYear()}} г.</div>
                            <div>{{relate.relation_russian}}</div>
                        </div>
                    </template>
                    <template v-if="relate.manga">
                        <div class="img-wrap">
                            <img :src="'https://shikimori.org/'+relate.manga.image.x96" alt="">
                        </div>
                        <div>
                            <h6>{{relate.manga.russian}}</h6>
                            <div>{{ relatedKind(relate.manga.kind) }} {{ new Date(relate.manga.aired_on).getFullYear()}} г.</div>
                            <div>{{relate.relation_russian}}</div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>
    <template id="watch-tmp">
        <div class="watch">
            <div class='load-spinner' v-if="loading"></div>
            <div v-else>
                <div class='mb-2'>
                    <button class="btn btn-outline-secondary btn-sm" @click="back"><i class="fa fa-arrow-left" aria-hidden="true"></i> Назад</button>
                </div>
                <h3 class="mb-2">{{ anime.russian }} [{{ watch.ep }} / {{ anime.episodes_aired || anime.episodes }}]</h3>
                <div class="row">
                    <div class="col-lg-8 mb-3">
                        <div class="player-contaier embed-responsive embed-responsive-16by9">
                            
                            <iframe :src="videoEmbed" frameborder="0" id="player" class='embed-responsive-item' v-if="!loadingVideo" allowfullscreen></iframe>
                            <div class='load-spinner center' v-else></div>
                        </div>
                    </div>
                    <div class="col-lg-4 video-variants">
                        <b-card no-body>
                            <b-tabs ref="tabs">
                                <b-tab title="Озвучка" active>
                                    <ul class="video-players fandub">
                                        <li v-for="video in videos.fandub" v-if="video.author && video.author.length" :class="{active: video.video_id === videos.player.video_id}" @click="change_videoId(video.video_id)" class="d-flex justify-content-between">
                                            <span>{{ video.author }}</span><span class="hosting">{{ video.hosting }}</span>
                                        </li>
                                    </ul>
                                </b-tab>
                                <b-tab title="Субтитры">
                                    <ul class="video-players sub">
                                        <li v-for="video in videos.sub" v-if="video.author && video.author.length" :class="{active: video.video_id === videos.player.video_id, eng: video.kindClass && video.kindClass.indexOf('english') !== -1}" @click="change_videoId(video.video_id)" class="d-flex justify-content-between">
                                            <span>{{ video.author }}</span><span class="hosting">{{ video.hosting }}</span>
                                        </li>
                                    </ul>
                                </b-tab>
                                <b-tab title="Оригинал">
                                    <ul class="video-players raw">
                                        <li v-for="video in videos.raw" v-if="video.author && video.author.length" :class="{active: video.video_id === videos.player.video_id}" @click="change_videoId(video.video_id)" class="d-flex justify-content-between">
                                            <span>{{ video.author }}</span><span class="hosting">{{ video.hosting }}</span>
                                        </li>
                                    </ul>
                                </b-tab>
                            </b-tabs>
                        </b-card>
                        <select id="select-ep" class="form-control" v-model="watch.ep">
                            <option v-for="epNum in anime.availableEp" :value="epNum" @click="watch.videoId=null">{{epNum}} серия</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-outline-warning" :class="{disabled: watch.ep === 1}" @click="prevEp"><i class="fa fa-arrow-left" aria-hidden="true"></i> Предыдущая серия</button>
                    <button class="btn" :class="{'btn-outline-info': !anime.watched || watch.ep > anime.watched, 'btn-info': watch.ep <= anime.watched}" @click="markAsWatched"><i class="fa fa-check" aria-hidden="true"></i> Просмотрено</button>
                    <button class="btn btn-outline-warning" :class="{disabled: watch.ep === (anime.episodes_aired || anime.episodes)}" @click="nextEp"><i class="fa fa-arrow-right" aria-hidden="true"></i> Следующая серия</button>
                </div>
            </div>
        </div>
    </template>
    <template id="media-tmp">
       <div class="media-item-wrap">
            <div class="modal-mask" @click="active=false" v-if="active">
                <div class="modal-wrapper">
                    <img :src="'https://shikimori.org/'+full" alt='' v-if="isImage">
                    <div class="youtube embed-responsive embed-responsive-16by9" v-else>
                        <iframe class="embed-responsive-item" :src="full" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            <div class="media-content" v-if="isImage" @click="active=true">
                <i class="fa fa-search-plus" aria-hidden="true"></i>
                <img :src="'https://shikimori.org/'+preview" alt="">
            </div>
            <div class="media-content" v-else @click="active=true">
                <i class="fa fa-youtube-play" aria-hidden="true"></i>
                <img :src="preview" alt="">
            </div>
       </div>
    </template>
    
    <template id="about-tmp">
        <div id="about">
            <h5>Разработчики</h5>
            <ul>
                <li>VLADOS776</li>
                <li>Dinaki - <a href="#" @click="browser('http://patreon.com/dinaki')">Patreon</a></li>
            </ul>
            <a href="#" @click="browser('https://vk.com/anime.list')">Сообщество VK</a>
        </div>
    </template>
    <script src="js/libs/popper.min.js"></script>
    
    <script src='js/main.js'></script>
  </body>
</html>